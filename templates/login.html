<!-- templates/login.html -->

{% extends "base.html" %}

{% block content %}
<h2>Вход через Telegram</h2>
<p>Пожалуйста, подождите, выполняется вход...</p>

<!-- Подключаем Telegram Web Apps SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        const tg = window.Telegram.WebApp;

        // Проверяем наличие данных авторизации
        if (tg.initData) {
            // Отправляем init_data на сервер для аутентификации
            fetch('{{ url_for('telegram_auth', _external=True) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({init_data: tg.initData})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Перенаправляем пользователя на главную страницу
                    window.location.href = '{{ url_for('index') }}';
                } else {
                    // Обработка ошибки
                    alert('Ошибка авторизации: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке данных на сервер:', error);
                alert('Произошла ошибка при авторизации.');
            });
        } else {
            // Если данные пользователя недоступны
            alert('Информация о пользователе недоступна. Пожалуйста, запустите приложение из Telegram.');
        }
    });
</script>
{% endblock %}
